<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Manager Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        button {
            padding: 5px 10px;
            margin: 2px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .two-column {
            display: grid;
            grid-template-columns: 50% 50%; /* Two columns, each 50% */
            grid-template-rows: auto auto; /* Two rows */
            gap: 16px; /* Adjust the gap between grid items if needed */
        }

        .league-table tr td {
            width: 10%;
        }
        .league-table tr td:nth-child(1) {
            width: 50%;
        }
        .vertical-table tr td:nth-child(1) {
            width: 50%;
        }

        .team-link, .player-link {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        #team-popup, #transfer-popup, #history-popup, #fixtures-popup, #table-popup, #player-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            width: 900px;
        }
        #popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .popup-header {
            position: relative;
            margin-bottom: 10px;
        }
        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 5px;
        }
        .league-tabs {
            margin-bottom: 10px;
        }
        tr.champions {
            background-color: #ffd700;
            border-top: 2px solid #b8860b;
        }
        tr.euro-league {
            background-color: #d4edda;
        }
        tr.euro-league:last-child {
            border-bottom: 2px solid #28a745;
        }
        tr.secondary-euro {
            background-color: #cce5ff;
        }
        tr.secondary-euro:last-child {
            border-bottom: 2px solid #007bff;
        }
        tr.auto-promotion {
            background-color: #d4edda;
            border-top: 2px solid #28a745;
        }
        tr.playoff {
            background-color: #fff3cd;
        }
        tr.playoff:last-child {
            border-bottom: 2px solid #ffc107;
        }
        tr.relegation {
            background-color: #f8d7da;
        }
        tr.relegation:first-child {
            border-top: 2px solid #dc3545;
        }
        tr.your-team {
            background-color: #e6ccff;
            font-weight: bold;
        }
        tr.your-team-result {
            background-color: #e6ccff;
        }
    </style>
</head>
<body>
<h1>Football Manager</h1>
<div id="controls">
    <button onclick="showTeamPopup(0)">Your Team</button>
    <button onclick="nextAction()" id="next-action-button">Next Match Day</button>
    <button onclick="showTransferPopup()">Transfer Market</button>
    <button onclick="showHistoryPopup()">Results</button>
    <button onclick="showFixturesPopup()">Fixtures</button>
    <button onclick="showTablePopup()">League Table</button>
</div>
<div id="match-result"></div>
<div id="popup-overlay" onclick="hideAllPopups()"></div>
<div id="team-popup"></div>
<div id="transfer-popup"></div>
<div id="history-popup"></div>
<div id="fixtures-popup"></div>
<div id="table-popup"></div>
<div id="player-popup"></div>

<script>
    // Game Logic
    class Player {
        constructor(name, position, skills, value, wage, age, nationality) {
            this.name = name;
            this.position = position;
            this.skills = skills; // { passing, tackling, pace, heading, stamina, shooting }
            this.value = value;
            this.wage = wage;
            this.age = age;
            this.nationality = nationality;
        }

        getAverageSkill() {
            return Object.values(this.skills).reduce((sum, val) => sum + val, 0) / 6;
        }
    }

    class Team {
        constructor(name, formation, leagueTier, stadiumCapacity, popularity) {
            this.name = name;
            this.formation = formation;
            this.leagueTier = leagueTier;
            this.stadiumCapacity = stadiumCapacity;
            this.popularity = popularity;
            this.players = [];
            this.points = 0;
            this.played = 0;
            this.wins = 0;
            this.draws = 0;
            this.losses = 0;
            this.budget = 50;
            this.wageBill = 0;
        }

        addPlayer(player) {
            this.players.push(player);
            this.wageBill += player.wage;
            if (this.name === yourTeamName) {
                this.updateStartingXI(player);
            }
        }

        removePlayer(index) {
            const player = this.players.splice(index, 1)[0];
            this.wageBill -= player.wage;
            return player;
        }

        getTeamSkill() {
            let startingXI = this.players.slice(0, 11);
            let totalSkill = startingXI.reduce((sum, player) => sum + player.getAverageSkill(), 0);
            return totalSkill / startingXI.length || 0;
        }

        updateStartingXI(newPlayer) {
            const formationMap = {
                "4-4-2": { gk: 1, def: 4, mid: 4, fwd: 2 },
                "4-3-3": { gk: 1, def: 4, mid: 3, fwd: 3 },
                "3-5-2": { gk: 1, def: 3, mid: 5, fwd: 2 },
                "4-2-3-1": { gk: 1, def: 4, mid: 5, fwd: 1 }
            };
            const formation = formationMap[this.formation];
            let startingXI = this.players.slice(0, 11);
            let positionPlayers = startingXI.filter(p => p.position === newPlayer.position);
            if (positionPlayers.length === 0) return;

            let weakestPlayer = positionPlayers.reduce((min, p) => p.getAverageSkill() < min.getAverageSkill() ? p : min, positionPlayers[0]);
            if (newPlayer.getAverageSkill() > weakestPlayer.getAverageSkill()) {
                let weakestIndex = startingXI.indexOf(weakestPlayer);
                this.players.splice(this.players.length - 1, 1);
                this.players.splice(weakestIndex, 1, newPlayer);
                this.players.push(weakestPlayer);
            }
        }
    }

    class Match {
        constructor(team1, team2) {
            this.team1 = team1;
            this.team2 = team2;
        }

        simulate() {
            let skill1 = this.team1.getTeamSkill();
            let skill2 = this.team2.getTeamSkill();
            let score1 = Math.floor(Math.random() * 5 * (skill1 / 100));
            let score2 = Math.floor(Math.random() * 5 * (skill2 / 100));

            this.team1.played++;
            this.team2.played++;
            if (score1 > score2) {
                this.team1.points += 3;
                this.team1.wins++;
                this.team2.losses++;
                this.team1.popularity = Math.min(this.team1.popularity + 2, 100);
                this.team2.popularity = Math.max(this.team2.popularity - 1, 0);
            } else if (score2 > score1) {
                this.team2.points += 3;
                this.team2.wins++;
                this.team1.losses++;
                this.team2.popularity = Math.min(this.team2.popularity + 2, 100);
                this.team1.popularity = Math.max(this.team1.popularity - 1, 0);
            } else {
                this.team1.points += 1;
                this.team2.points += 1;
                this.team1.draws++;
                this.team2.draws++;
            }

            const ticketPrice = 20;
            const attendance = Math.min(
                Math.floor((this.team1.popularity + this.team2.popularity) / 200 * this.team1.stadiumCapacity),
                this.team1.stadiumCapacity
            );
            const totalIncome = attendance * ticketPrice / 1000000;
            const splitIncome = totalIncome / 2;
            this.team1.budget += splitIncome;
            this.team2.budget += splitIncome;

            return {
                homeTeam: this.team1.name,
                awayTeam: this.team2.name,
                homeScore: score1,
                awayScore: score2,
                attendance: attendance
            };
        }
    }

    class League {
        constructor(teams, tier) {
            this.teams = teams;
            this.tier = tier;
            this.matchDay = 0;
            this.matchDays = this.generateMatchDays();
            this.history = [];
        }

        isSeasonOver() {
            return this.matchDay >= this.matchDays.length;
        }

        generateMatchDays() {
            const n = this.teams.length;
            const matchDays = [];
            const teamIndices = Array.from({ length: n }, (_, i) => i);

            for (let round = 0; round < n - 1; round++) {
                let dayFixtures = [];
                let usedTeams = new Set();

                for (let i = 0; i < n / 2; i++) {
                    let team1 = teamIndices[i];
                    let team2 = teamIndices[n - 1 - i];
                    if (!usedTeams.has(team1) && !usedTeams.has(team2)) {
                        dayFixtures.push([this.teams[team1], this.teams[team2]]);
                        usedTeams.add(team1);
                        usedTeams.add(team2);
                    }
                }

                matchDays.push(dayFixtures);
                teamIndices.splice(1, 0, teamIndices.pop());
            }

            matchDays.forEach(day => {
                for (let i = day.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [day[i], day[j]] = [day[j], day[i]];
                }
            });

            return matchDays;
        }

        simulateMatchDay() {
            if (this.isSeasonOver()) {
                return [{ homeTeam: "Season", awayTeam: "Over!", homeScore: 0, awayScore: 0, attendance: 0 }];
            }
            let results = [];
            let todayFixtures = this.matchDays[this.matchDay];
            for (let fixture of todayFixtures) {
                let match = new Match(fixture[0], fixture[1]);
                results.push(match.simulate());
            }
            this.teams.forEach(team => {
                team.budget -= team.wageBill / 1000;
            });
            this.history.push({ matchDay: this.matchDay + 1, results: results });
            this.matchDay++;
            return results;
        }

        getStandings() {
            return this.teams.sort((a, b) => b.points - a.points || b.wins - a.wins);
        }

        getFutureFixtures() {
            let future = [];
            for (let i = this.matchDay; i < this.matchDays.length; i++) {
                let dayFixtures = this.matchDays[i].map(fixture =>
                    `${fixture[0].name} vs ${fixture[1].name}`
                );
                future.push({ matchDay: i + 1, fixtures: dayFixtures });
            }
            return future;
        }

        getTodayResults() {
            return this.history[this.matchDay - 1]?.results ?? [];
        }
    }

    const teamNames = [
        "Grok United", "AI City", "Tech Rovers", "Code Warriors", "Pixel Town",
        "Data Dynamos", "Byte Blitz", "Circuit Strikers", "Nitro FC", "Quantum Kickers",
        "Silicon Stars", "Gridiron Gurus", "Binary Blades", "Cyber Celtics", "Neon Nomads",
        "Flux Fighters", "Pulse Pioneers", "Echo Eagles", "Vortex Vipers", "Spark Spartans",
        "Steel Stingers", "Cloud Chasers", "Nova Knights", "Gizmo Giants", "Turbo Titans",
        "Wave Wanderers", "Core Crusaders", "Pixel Pirates", "Tech Tornadoes", "Byte Bandits",
        "Circuit Cyclones", "Data Dragons", "Quantum Quasars", "Neon Ninjas", "Flux Flyers",
        "Pulse Panthers", "Echo Elites", "Vortex Victors", "Spark Scorpions", "Grid Gliders",
        "Iron Ions", "Sky Sentinels", "Lunar Legends", "Code Commanders", "Bit Blasters",
        "Wire Wolves", "Tech Templars", "Nano Navigators", "Pulse Prowlers", "Echo Enforcers",
        "Vortex Voyagers", "Spark Seekers", "Grid Guardians", "Byte Brawlers", "Circuit Chargers",
        "Data Defenders", "Quantum Questers", "Neon Nomads", "Flux Force", "Core Captains",
        "Laser Lions", "Sonic Stags", "Blaze Bears", "Thunder Thorns", "Frost Falcons",
        "Gale Griffins", "Rift Ravens", "Tide Titans", "Peak Pumas", "Crest Cobras",
        "Drift Ducks", "Bolt Badgers", "Surge Sharks", "Glint Gators", "Haze Hawks",
        "Void Vultures", "Rush Rhinos", "Flare Foxes", "Chill Cheetahs", "Storm Stallions"
    ];

    const firstNames = [
        "Alex", "Ben", "Chris", "Dave", "Evan", "Frank", "Gino", "Hank", "Ivan", "Jack",
        "Kevin", "Leo", "Miles", "Ned", "Oli", "Patrick", "Quinn", "Ron", "Sam", "Trevor",
        "Stan", "Vince", "Wes", "Xander", "Zack", "Zane"
    ];
    const lastNames = [
        "Smith", "Johnson", "Brown", "Taylor", "Wilson", "Davis", "Clark", "Lewis",
        "Walker", "Hall", "Young", "King", "Wright", "Hill", "Scott", "Green"
    ];
    const nationalities = [
        "England", "Spain", "Germany", "France", "Italy", "Brazil", "Argentina", "Portugal",
        "Netherlands", "Belgium", "Scotland", "Wales", "Ireland", "Sweden", "Norway"
    ];

    const formations = [
        { name: "4-4-2", gk: 1, def: 4, mid: 4, fwd: 2 },
        { name: "4-3-3", gk: 1, def: 4, mid: 3, fwd: 3 },
        { name: "3-5-2", gk: 1, def: 3, mid: 5, fwd: 2 },
        { name: "4-2-3-1", gk: 1, def: 4, mid: 5, fwd: 1 }
    ];

    function calculateValue(skills, age) {
        let avgSkill = Object.values(skills).reduce((sum, val) => sum + val, 0) / 6;
        let baseValue = (avgSkill - 40) * 0.5;
        let ageMultiplier = age < 25 ? (0.5 + (age - 18) * 0.0714) :
            age <= 30 ? 1.0 :
                (1.0 - (age - 30) * 0.0714);
        return Math.max(baseValue * ageMultiplier, 0).toFixed(1);
    }
    function calculateWage(skills) {
        let avgSkill = Object.values(skills).reduce((sum, val) => sum + val, 0) / 6;
        return Math.floor((avgSkill - 40) * 2);
    }

    function generateSkills(min, max) {
        return {
            passing: Math.floor(Math.random() * (max - min + 1)) + min,
            tackling: Math.floor(Math.random() * (max - min + 1)) + min,
            pace: Math.floor(Math.random() * (max - min + 1)) + min,
            heading: Math.floor(Math.random() * (max - min + 1)) + min,
            stamina: Math.floor(Math.random() * (max - min + 1)) + min,
            shooting: Math.floor(Math.random() * (max - min + 1)) + min
        };
    }

    function generateTeam(name, leagueTier) {
        const formation = formations[Math.floor(Math.random() * formations.length)];
        const stadiumCapacity = Math.floor(Math.random() * 70000) + 10000;
        const popularity = leagueTier === 0 ? Math.floor(Math.random() * 31) + 70 :
            leagueTier === 1 ? Math.floor(Math.random() * 41) + 40 :
                leagueTier === 2 ? Math.floor(Math.random() * 41) + 30 :
                    Math.floor(Math.random() * 41) + 20;
        let team = new Team(name, formation.name, leagueTier, stadiumCapacity, popularity);

        team.addPlayer(new Player(
            `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
            "Goalkeeper",
            generateSkills(60, 100),
            0,
            0,
            Math.floor(Math.random() * 18) + 18,
            nationalities[Math.floor(Math.random() * nationalities.length)]
        ));
        team.players[0].value = calculateValue(team.players[0].skills, team.players[0].age);
        team.players[0].wage = calculateWage(team.players[0].skills);
        for (let i = 0; i < formation.def; i++) {
            let skills = generateSkills(60, 100);
            let age = Math.floor(Math.random() * 18) + 18;
            team.addPlayer(new Player(
                `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                "Defender",
                skills,
                calculateValue(skills, age),
                calculateWage(skills),
                age,
                nationalities[Math.floor(Math.random() * nationalities.length)]
            ));
        }
        for (let i = 0; i < formation.mid; i++) {
            let skills = generateSkills(60, 100);
            let age = Math.floor(Math.random() * 18) + 18;
            team.addPlayer(new Player(
                `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                "Midfielder",
                skills,
                calculateValue(skills, age),
                calculateWage(skills),
                age,
                nationalities[Math.floor(Math.random() * nationalities.length)]
            ));
        }
        for (let i = 0; i < formation.fwd; i++) {
            let skills = generateSkills(60, 100);
            let age = Math.floor(Math.random() * 18) + 18;
            team.addPlayer(new Player(
                `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                "Forward",
                skills,
                calculateValue(skills, age),
                calculateWage(skills),
                age,
                nationalities[Math.floor(Math.random() * nationalities.length)]
            ));
        }

        let subSkillsRange = [50, 85];
        team.addPlayer(new Player(
            `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
            "Goalkeeper",
            generateSkills(subSkillsRange[0], subSkillsRange[1]),
            0,
            0,
            Math.floor(Math.random() * 18) + 18,
            nationalities[Math.floor(Math.random() * nationalities.length)]
        ));
        team.players[team.players.length - 1].value = calculateValue(team.players[team.players.length - 1].skills, team.players[team.players.length - 1].age);
        team.players[team.players.length - 1].wage = calculateWage(team.players[team.players.length - 1].skills);
        for (let i = 0; i < 2; i++) {
            let skills = generateSkills(subSkillsRange[0], subSkillsRange[1]);
            let age = Math.floor(Math.random() * 18) + 18;
            team.addPlayer(new Player(
                `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                "Defender",
                skills,
                calculateValue(skills, age),
                calculateWage(skills),
                age,
                nationalities[Math.floor(Math.random() * nationalities.length)]
            ));
        }
        team.addPlayer(new Player(
            `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
            "Midfielder",
            generateSkills(subSkillsRange[0], subSkillsRange[1]),
            0,
            0,
            Math.floor(Math.random() * 18) + 18,
            nationalities[Math.floor(Math.random() * nationalities.length)]
        ));
        team.players[team.players.length - 1].value = calculateValue(team.players[team.players.length - 1].skills, team.players[team.players.length - 1].age);
        team.players[team.players.length - 1].wage = calculateWage(team.players[team.players.length - 1].skills);
        team.addPlayer(new Player(
            `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
            "Forward",
            generateSkills(subSkillsRange[0], subSkillsRange[1]),
            0,
            0,
            Math.floor(Math.random() * 18) + 18,
            nationalities[Math.floor(Math.random() * nationalities.length)]
        ));
        team.players[team.players.length - 1].value = calculateValue(team.players[team.players.length - 1].skills, team.players[team.players.length - 1].age);
        team.players[team.players.length - 1].wage = calculateWage(team.players[team.players.length - 1].skills);

        for (let i = 0; i < 3; i++) {
            let randomPosition = ["Goalkeeper", "Defender", "Midfielder", "Forward"][Math.floor(Math.random() * 4)];
            let skills = generateSkills(40, 70);
            let age = Math.floor(Math.random() * 18) + 18;
            team.addPlayer(new Player(
                `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                randomPosition,
                skills,
                calculateValue(skills, age),
                calculateWage(skills),
                age,
                nationalities[Math.floor(Math.random() * nationalities.length)]
            ));
        }

        return team;
    }

    const yourTeamName = "Grok United";
    let leagues = [
        new League(teamNames.slice(0, 20).map(name => generateTeam(name, 0)), 0),
        new League(teamNames.slice(20, 40).map(name => generateTeam(name, 1)), 1),
        new League(teamNames.slice(40, 60).map(name => generateTeam(name, 2)), 2),
        new League(teamNames.slice(60, 80).map(name => generateTeam(name, 3)), 3)
    ];
    let yourTeamLeagueIndex = 0;
    let currentHistoryDay = 0;
    let currentFutureDay = 0;
    let transferList = [];
    let seasonNumber = 1;
    let currentResultLeague = 0;

    function generateTransferList() {
        transferList = [];
        const positions = ["Goalkeeper", "Defender", "Midfielder", "Forward"];
        for (let i = 0; i < 10; i++) {
            let skills = generateSkills(40, 100);
            let position = positions[Math.floor(Math.random() * positions.length)];
            let age = Math.floor(Math.random() * 18) + 18;
            transferList.push(new Player(
                `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                position,
                skills,
                calculateValue(skills, age),
                calculateWage(skills),
                age,
                nationalities[Math.floor(Math.random() * nationalities.length)]
            ));
        }
    }

    function generateYouthPlayer(position) {
        let skills = generateSkills(50, 80);
        let age = 18;
        return new Player(
            `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
            position,
            skills,
            calculateValue(skills, age),
            calculateWage(skills),
            age,
            nationalities[Math.floor(Math.random() * nationalities.length)]
        );
    }

    function simulatePlayoff(teams) {
        let semi1 = new Match(teams[0], teams[3]).simulate();
        let semi2 = new Match(teams[1], teams[2]).simulate();
        let winner1 = semi1.homeScore > semi1.awayScore ? teams[0] : teams[3];
        let winner2 = semi2.homeScore > semi2.awayScore ? teams[1] : teams[2];
        let final = new Match(winner1, winner2).simulate();
        return final.homeScore > final.awayScore ? winner1 : winner2;
    }

    // UI Functions
    function nextAction() {
        if (leagues.every(league => league.isSeasonOver())) {
            newSeason();
        } else {
            simulateMatchDay();
        }
    }

    function simulateMatchDay() {
        leagues.forEach(league => league.simulateMatchDay());
        currentHistoryDay = leagues[yourTeamLeagueIndex].history.length - 1;
        displayMatchDayResults();
        setNextActionButtonText();
    }

    function displayMatchDayResults() {
        let resultDiv = document.getElementById("match-result");
        let matchDay = leagues[yourTeamLeagueIndex].matchDay;
        resultDiv.innerHTML = `<h3>Season ${seasonNumber} - Match Day ${matchDay} Results:</h3>`;
        resultDiv.innerHTML += `
                <div class="league-tabs">
                    <button onclick="currentResultLeague=0;displayMatchDayResults()">Premier League</button>
                    <button onclick="currentResultLeague=1;displayMatchDayResults()">Championship</button>
                    <button onclick="currentResultLeague=2;displayMatchDayResults()">League One</button>
                    <button onclick="currentResultLeague=3;displayMatchDayResults()">League Two</button>
                </div>
            `;
        let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Home Team</th>
                            <th>Score</th>
                            <th>Away Team</th>
                            <th>Attendance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        let results = leagues[currentResultLeague].getTodayResults();
        results.forEach(result => {
            let isYourTeam = result.homeTeam === yourTeamName || result.awayTeam === yourTeamName;
            tableHTML += `
                    <tr ${isYourTeam ? 'class="your-team-result"' : ''}>
                        <td>${result.homeTeam}</td>
                        <td>${result.homeScore} - ${result.awayScore}</td>
                        <td>${result.awayTeam}</td>
                        <td>${result.attendance}</td>
                    </tr>
                `;
        });
        tableHTML += `</tbody></table>`;
        resultDiv.innerHTML += tableHTML;
    }

    function setNextActionButtonText() {
        const button = document.getElementById("next-action-button");
        button.innerText = leagues.every(league => league.isSeasonOver()) ? "Next Season" : "Next Match Day";
    }

    function newSeason() {
        leagues.forEach(league => {
            let standings = league.getStandings();
            const prizeMoney = league.tier === 0 ? [50, 45, 40, 35, 30, 28, 26, 24, 22, 20, 18, 16, 14, 12, 10, 9, 8, 7, 6, 5] :
                league.tier === 1 ? [20, 18, 16, 14, 12, 10, 9, 8, 7, 6, 5, 4, 3, 2.5, 2, 1.8, 1.6, 1.4, 1.2, 1] :
                    league.tier === 2 ? [10, 9, 8, 7, 6, 5, 4.5, 4, 3.5, 3, 2.5, 2, 1.8, 1.6, 1.4, 1.2, 1, 0.9, 0.8, 0.7] :
                        [5, 4.5, 4, 3.5, 3, 2.5, 2, 1.8, 1.6, 1.4, 1.2, 1, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2];
            standings.forEach((team, index) => {
                team.budget += prizeMoney[index];
                team.points = 0;
                team.played = 0;
                team.wins = 0;
                team.draws = 0;
                team.losses = 0;

                let retirees = [];
                team.players.forEach((player, index) => {
                    player.age += 1;
                    player.value = calculateValue(player.skills, player.age);
                    if (player.age > 35) retirees.push(index);
                });
                for (let i = retirees.length - 1; i >= 0; i--) {
                    let retiredPlayer = team.removePlayer(retirees[i]);
                    let youth = generateYouthPlayer(retiredPlayer.position);
                    team.addPlayer(youth);
                }
            });

            if (league.tier === 0) {
                let relegated = standings.slice(-3);
                let promoted = leagues[1].getStandings();
                let autoPromoted = promoted.slice(0, 2);
                let playoffTeams = promoted.slice(2, 6);
                let playoffWinner = simulatePlayoff(playoffTeams);
                league.teams = standings.slice(0, -3).concat(autoPromoted).concat([playoffWinner]);
                leagues[1].teams = promoted.filter(t => !autoPromoted.includes(t) && t !== playoffWinner).concat(relegated);
            } else if (league.tier === 1) {
                let relegated = standings.slice(-3);
                let promoted = leagues[2].getStandings();
                let autoPromoted = promoted.slice(0, 2);
                let playoffTeams = promoted.slice(2, 6);
                let playoffWinner = simulatePlayoff(playoffTeams);
                league.teams = standings.slice(0, -3).concat(autoPromoted).concat([playoffWinner]);
                leagues[2].teams = promoted.filter(t => !autoPromoted.includes(t) && t !== playoffWinner).concat(relegated);
            } else if (league.tier === 2) {
                let relegated = standings.slice(-3);
                let promoted = leagues[3].getStandings();
                let autoPromoted = promoted.slice(0, 3);
                let playoffTeams = promoted.slice(3, 7);
                let playoffWinner = simulatePlayoff(playoffTeams);
                league.teams = standings.slice(0, -3).concat(autoPromoted).concat([playoffWinner]);
                leagues[3].teams = promoted.filter(t => !autoPromoted.includes(t) && t !== playoffWinner).concat(relegated);
            }
        });

        yourTeamLeagueIndex = leagues.findIndex(league => league.teams.some(team => team.name === yourTeamName));
        leagues.forEach(league => {
            league.matchDay = 0;
            league.history = [];
            league.matchDays = league.generateMatchDays();
        });
        currentHistoryDay = 0;
        currentFutureDay = 0;
        generateTransferList();
        seasonNumber++;
        let resultDiv = document.getElementById("match-result");
        resultDiv.innerHTML = `<h3>Season ${seasonNumber} Started!</h3>`;
        hideAllPopups();
        setNextActionButtonText();
    }

    function showTeamPopup(teamIndex) {
        let league = leagues[yourTeamLeagueIndex];
        let team = league.teams[teamIndex];
        let popup = document.getElementById("team-popup");
        let overlay = document.getElementById("popup-overlay");
        let avgRating = team.getTeamSkill().toFixed(1);

        let html = `
                <div class="popup-header">
                    <h3>${team.name} (${["Premier League", "Championship", "League One", "League Two"][team.leagueTier]})</h3>
                    <span class="close-btn" onclick="hideTeamPopup()">X</span>
                </div>
                <p><strong>Formation:</strong> ${team.formation}</p>
                <p><strong>Average Starting XI Rating:</strong> ${avgRating}</p>
                <p><strong>Budget:</strong> £${team.budget.toFixed(1)}M</p>
                <p><strong>Weekly Wage Bill:</strong> £${team.wageBill}K</p>
                <p><strong>Stadium Capacity:</strong> ${team.stadiumCapacity}</p>
                <p><strong>Popularity:</strong> ${team.popularity}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Position</th>
                            <th>Avg Skill</th>
                            <th>Age</th>
                            <th>Value</th>
                            <th>Wage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6"><h4>Starting XI</h4></td>
                        </tr>
            `;
        team.players.slice(0, 11).forEach((player, index) => {
            html += `
                    <tr>
                        <td><span class="player-link" onclick="showPlayerPopup('team', ${teamIndex}, ${index})">${player.name}</span></td>
                        <td>${player.position}</td>
                        <td>${player.getAverageSkill().toFixed(1)}</td>
                        <td>${player.age}</td>
                        <td>£${player.value}M</td>
                        <td>£${player.wage}K</td>
                    </tr>
                `;
        });

        html += `
                        <tr>
                            <td colspan="6"><h4>Substitutes</h4></td>
                        </tr>
            `;
        team.players.slice(11, 16).forEach((player, index) => {
            html += `
                    <tr>
                        <td><span class="player-link" onclick="showPlayerPopup('team', ${teamIndex}, ${index + 11})">${player.name}</span></td>
                        <td>${player.position}</td>
                        <td>${player.getAverageSkill().toFixed(1)}</td>
                        <td>${player.age}</td>
                        <td>£${player.value}M</td>
                        <td>£${player.wage}K</td>
                    </tr>
                `;
        });

        html += `
                        <tr>
                            <td colspan="6"><h4>Reserves</h4></td>
                        </tr>
            `;
        team.players.slice(16).forEach((player, index) => {
            html += `
                    <tr>
                        <td><span class="player-link" onclick="showPlayerPopup('team', ${teamIndex}, ${index + 16})">${player.name}</span></td>
                        <td>${player.position}</td>
                        <td>${player.getAverageSkill().toFixed(1)}</td>
                        <td>${player.age}</td>
                        <td>£${player.value}M</td>
                        <td>£${player.wage}K</td>
                    </tr>
                `;
        });
        html += `</tbody></table>`;

        popup.innerHTML = html;
        popup.style.display = "block";
        overlay.style.display = "block";
    }

    function hideTeamPopup() {
        document.getElementById("team-popup").style.display = "none";
        document.getElementById("popup-overlay").style.display = "none";
    }

    function showTransferPopup() {
        let popup = document.getElementById("transfer-popup");
        let overlay = document.getElementById("popup-overlay");
        let html = `
                <div class="popup-header">
                    <h3>Transfer Market (Your Budget: £${leagues[yourTeamLeagueIndex].teams[0].budget.toFixed(1)}M)</h3>
                    <span class="close-btn" onclick="hideTransferPopup()">X</span>
                </div>
            `;
        if (transferList.length === 0) {
            html += "<p>No players available for transfer.</p>";
        } else {
            html += `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Position</th>
                                <th>Avg Skill</th>
                                <th>Age</th>
                                <th>Value</th>
                                <th>Wage</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
            transferList.forEach((player, index) => {
                html += `
                        <tr>
                            <td><span class="player-link" onclick="showPlayerPopup('transfer', ${index})">${player.name}</span></td>
                            <td>${player.position}</td>
                            <td>${player.getAverageSkill().toFixed(1)}</td>
                            <td>${player.age}</td>
                            <td>£${player.value}M</td>
                            <td>£${player.wage}K</td>
                        </tr>
                    `;
            });
            html += `</tbody></table>`;
        }
        popup.innerHTML = html;
        popup.style.display = "block";
        overlay.style.display = "block";
    }

    function hideTransferPopup() {
        document.getElementById("transfer-popup").style.display = "none";
        document.getElementById("popup-overlay").style.display = "none";
    }

    function showPlayerPopup(source, index1, index2 = null) {
        let player, teamIndex, playerIndex, isYourTeam;
        if (source === 'team') {
            teamIndex = index1;
            playerIndex = index2;
            player = leagues[yourTeamLeagueIndex].teams[teamIndex].players[playerIndex];
            isYourTeam = teamIndex === 0;
        } else if (source === 'transfer') {
            playerIndex = index1;
            player = transferList[playerIndex];
            isYourTeam = false;
        }

        let popup = document.getElementById("player-popup");
        let overlay = document.getElementById("popup-overlay");
        let html = `
                <div class="popup-header">
                    <h3>${player.name}</h3>
                    <span class="close-btn" onclick="hidePlayerPopup()">X</span>
                </div>
                <div class="two-column">
                    <table class="vertical-table">
                        <tbody>
                            <tr>
                                <td>Current team</td>
                                <td>${leagues[yourTeamLeagueIndex].teams[teamIndex].name}</td>
                             </tr>
                            <tr>
                                <td>Age</td>
                                <td>${player.age}</td>
                             </tr>
                            <tr>
                                <td>Nationality</td>
                                <td>${player.nationality}</td>
                             </tr>
                            <tr>
                                <td>Position</td>
                                <td>${player.position}</td>
                             </tr>
                            <tr>
                                <td>Value</td>
                                <td>${player.value}M</td>
                             </tr>
                            <tr>
                                <td>Wage</td>
                                <td>${player.wage}K</td>
                             </tr>
                         </tbody>
                    </table>

                    <table class="vertical-table">
                        <tbody>
                            <tr>
                                <td>Passing</td>
                                <td>${player.skills.passing}</td>
                             </tr>
                                <td>Tackling</td>
                                <td>${player.skills.tackling}</td>
                             </tr>
                                <td>Pace</td>
                                <td>${player.skills.pace}</td>
                             </tr>
                                <td>Heading</td>
                                <td>${player.skills.heading}</td>
                             </tr>
                                <td>Stamina</td>
                                <td>${player.skills.stamina}</td>
                             </tr>
                                <td>Shooting</td>
                                <td>${player.skills.shooting}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        if (isYourTeam) {
            html += `<button onclick="sellPlayerFromPopup(${teamIndex}, ${playerIndex});hidePlayerPopup()">Sell Player</button>`;
        } else if (source === 'transfer') {
            html += `<button onclick="buyPlayerFromPopup(${playerIndex});hidePlayerPopup()">Buy Player</button>`;
        }
        popup.innerHTML = html;
        popup.style.display = "block";
        overlay.style.display = "block";
    }

    function hidePlayerPopup() {
        document.getElementById("player-popup").style.display = "none";
        document.getElementById("popup-overlay").style.display = "none";
    }

    function sellPlayerFromPopup(teamIndex, playerIndex) {
        let team = leagues[yourTeamLeagueIndex].teams[teamIndex];
        let player = team.removePlayer(playerIndex);
        team.budget += parseFloat(player.value);
        showTeamPopup(teamIndex);
    }

    function buyPlayerFromPopup(transferIndex) {
        let player = transferList[transferIndex];
        let yourTeam = leagues[yourTeamLeagueIndex].teams[0];
        if (yourTeam.budget >= player.value && yourTeam.players.length < 25) {
            yourTeam.addPlayer(player);
            yourTeam.budget -= parseFloat(player.value);
            transferList.splice(transferIndex, 1);
            showTransferPopup();
        } else {
            alert("Not enough budget or squad space (max 25 players)!");
        }
    }

    function showHistoryPopup(leagueIndex = yourTeamLeagueIndex) {
        let popup = document.getElementById("history-popup");
        let overlay = document.getElementById("popup-overlay");
        let league = leagues[leagueIndex];
        popup.innerHTML = `
                <div class="popup-header">
                    <h3>Fixture History - ${["Premier League", "Championship", "League One", "League Two"][league.tier]}</h3>
                    <span class="close-btn" onclick="hideHistoryPopup()">X</span>
                </div>
                <div class="league-tabs">
                    <button onclick="showHistoryPopup(0)">Premier League</button>
                    <button onclick="showHistoryPopup(1)">Championship</button>
                    <button onclick="showHistoryPopup(2)">League One</button>
                    <button onclick="showHistoryPopup(3)">League Two</button>
                </div>
            `;
        let controlsHTML = "";
        let contentHTML = "";

        if (league.history.length === 0) {
            contentHTML = "<p>No matches played yet.</p>";
        } else {
            for (let i = 0; i < league.history.length; i++) {
                controlsHTML += `<button onclick="currentHistoryDay=${i};showHistoryPopup(${leagueIndex})">Day ${i + 1}</button>`;
            }
            let day = league.history[currentHistoryDay];
            contentHTML = `<h4>Match Day ${day.matchDay}:</h4>`;
            contentHTML += `
                    <table>
                        <thead>
                            <tr>
                                <th>Home Team</th>
                                <th>Score</th>
                                <th>Away Team</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
            day.results.forEach(result => {
                let isYourTeam = result.homeTeam === yourTeamName || result.awayTeam === yourTeamName;
                contentHTML += `
                        <tr ${isYourTeam ? 'class="your-team-result"' : ''}>
                            <td>${result.homeTeam}</td>
                            <td>${result.homeScore} - ${result.awayScore}</td>
                            <td>${result.awayTeam}</td>
                            <td>${result.attendance}</td>
                        </tr>
                    `;
            });
            contentHTML += `</tbody></table>`;
        }

        popup.innerHTML += `<div>${controlsHTML}</div><div>${contentHTML}</div>`;
        popup.style.display = "block";
        overlay.style.display = "block";
    }

    function hideHistoryPopup() {
        document.getElementById("history-popup").style.display = "none";
        document.getElementById("popup-overlay").style.display = "none";
    }

    function showFixturesPopup( leagueIndex = yourTeamLeagueIndex) {
        let popup = document.getElementById("fixtures-popup");
        let overlay = document.getElementById("popup-overlay");
        let league = leagues[leagueIndex];
        let futureFixtures = league.getFutureFixtures();
        popup.innerHTML = `
                <div class="popup-header">
                    <h3>Future Fixtures - ${["Premier League", "Championship", "League One", "League Two"][league.tier]}</h3>
                    <span class="close-btn" onclick="hideFixturesPopup()">X</span>
                </div>
                <div class="league-tabs">
                    <button onclick="showFixturesPopup(0)">Premier League</button>
                    <button onclick="showFixturesPopup(1)">Championship</button>
                    <button onclick="showFixturesPopup(2)">League One</button>
                    <button onclick="showFixturesPopup(3)">League Two</button>
                </div>
            `;
        let controlsHTML = "";
        let contentHTML = "";

        if (futureFixtures.length === 0) {
            contentHTML = "<p>Season Over!</p>";
        } else {
            currentFutureDay = Math.min(currentFutureDay, futureFixtures.length - 1);
            for (let i = 0; i < futureFixtures.length; i++) {
                controlsHTML += `<button onclick="currentFutureDay=${i};showFixturesPopup(${leagueIndex})">Day ${futureFixtures[i].matchDay}</button>`;
            }
            let day = futureFixtures[currentFutureDay];
            contentHTML = `<h4>Match Day ${day.matchDay}:</h4>`;
            contentHTML += `
                    <table>
                        <thead>
                            <tr>
                                <th>Home Team</th>
                                <th></th>
                                <th>Away Team</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
            day.fixtures.forEach(fixture => {
                const [home, away] = fixture.split(" vs ");
                let isYourTeam = home === yourTeamName || away === yourTeamName;
                contentHTML += `
                        <tr ${isYourTeam ? 'class="your-team-result"' : ''}>
                            <td>${home}</td>
                            <td>vs</td>
                            <td>${away}</td>
                        </tr>
                    `;
            });
            contentHTML += `</tbody></table>`;
        }

        popup.innerHTML += `<div>${controlsHTML}</div><div>${contentHTML}</div>`;
        popup.style.display = "block";
        overlay.style.display = "block";
    }

    function hideFixturesPopup() {
        document.getElementById("fixtures-popup").style.display = "none";
        document.getElementById("popup-overlay").style.display = "none";
    }

    function showTablePopup(leagueIndex = yourTeamLeagueIndex) {
        let popup = document.getElementById("table-popup");
        let overlay = document.getElementById("popup-overlay");
        let league = leagues[leagueIndex];
        let standings = league.getStandings();
        popup.innerHTML = `
                <div class="popup-header">
                    <h3>${["Premier League", "Championship", "League One", "League Two"][league.tier]} Table</h3>
                    <span class="close-btn" onclick="hideTablePopup()">X</span>
                </div>
                <div class="league-tabs">
                    <button onclick="showTablePopup(0)">Premier League</button>
                    <button onclick="showTablePopup(1)">Championship</button>
                    <button onclick="showTablePopup(2)">League One</button>
                    <button onclick="showTablePopup(3)">League Two</button>
                </div>
            `;
        let tableHTML = `
                <table class="league-table">
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>P</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        standings.forEach((team, index) => {
            let rowClass = '';
            if (league.tier === 0) {
                if (index === 0) rowClass = 'champions';
                else if (index < 4) rowClass = 'euro-league';
                else if (index < 6) rowClass = 'secondary-euro';
                else if (index >= 17) rowClass = 'relegation';
            } else if (league.tier === 1 || league.tier === 2) {
                if (index < 2) rowClass = 'auto-promotion';
                else if (index < 6) rowClass = 'playoff';
                else if (index >= 17) rowClass = 'relegation';
            } else if (league.tier === 3) {
                if (index < 3) rowClass = 'auto-promotion';
                else if (index < 7) rowClass = 'playoff';
            }
            if (team.name === yourTeamName) rowClass = 'your-team';
            tableHTML += `
                    <tr class="${rowClass}">
                        <td><span class="team-link" onclick="showTeamPopup(${index});hideTablePopup()">${team.name}</span></td>
                        <td>${team.played}</td>
                        <td>${team.wins}</td>
                        <td>${team.draws}</td>
                        <td>${team.losses}</td>
                        <td>${team.points}</td>
                    </tr>
                `;
        });
        tableHTML += `</tbody></table>`;
        popup.innerHTML += tableHTML;
        popup.style.display = "block";
        overlay.style.display = "block";
    }

    function hideTablePopup() {
        document.getElementById("table-popup").style.display = "none";
        document.getElementById("popup-overlay").style.display = "none";
    }

    function hideAllPopups() {
        hideTeamPopup();
        hideTransferPopup();
        hideHistoryPopup();
        hideFixturesPopup();
        hideTablePopup();
        hidePlayerPopup();
    }

    // Initial setup
    generateTransferList();
    window.onload = function() {
        let resultDiv = document.getElementById("match-result");
        resultDiv.innerHTML = `<h3>Welcome to Football Manager - Season ${seasonNumber}</h3>`;
        setNextActionButtonText();
    };
</script>
</body>
</html>